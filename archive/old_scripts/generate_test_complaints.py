#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∂–∞–ª–æ–±–∞–º–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
"""
import pandas as pd
import numpy as np
from datetime import datetime
from pathlib import Path

def generate_test_complaints():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –∂–∞–ª–æ–±–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö 112"""
    
    print("="*80)
    print("üß™ –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–• –° –ñ–ê–õ–û–ë–ê–ú–ò")
    print("="*80)
    
    # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª—ã 112
    print("\n[1/4] –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ 112...")
    files_112 = list(Path('123').glob('*.xlsx'))
    
    all_data = []
    for file in files_112:
        print(f"  ‚Ä¢ {file.name}")
        df = pd.read_excel(file)
        all_data.append(df)
    
    df_112 = pd.concat(all_data, ignore_index=True)
    print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df_112)} –∑–∞–ø–∏—Å–µ–π")
    
    # –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ –≤ Google Sheets
    print("\n[2/4] –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö...")
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º
    unique_cards = df_112['–ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞“õ–∞–º–∏'].unique()
    print(f"‚úì –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç: {len(unique_cards)}")
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã
    np.random.seed(42)
    sample_size = min(5000, len(unique_cards))  # 5000 –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞
    sampled_cards = np.random.choice(unique_cards, size=sample_size, replace=False)
    
    print(f"‚úì –í—ã–±—Ä–∞–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {sample_size} –∫–∞—Ä—Ç")
    
    # –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å–∏
    print("\n[3/4] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π...")
    records = []
    
    complaints = [
        '–î–æ–ª–≥–æ –µ—Ö–∞–ª–∏',
        '–ì—Ä—É–±–æ—Å—Ç—å',
        '–ù–µ –ø—Ä–∏–µ—Ö–∞–ª–∏',
        '–ù–µ –ø–æ–º–æ–≥–ª–∏',
        '–ü–ª–æ—Ö–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ',
        '–ó–∞–¥–µ—Ä–∂–∫–∞',
        '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å'
    ]
    
    positive_responses = ['–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ', '–•–æ—Ä–æ—à–æ']
    statuses = ['–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∑–≤–æ–Ω–∏—Ç—å—Å—è', '–î–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å', '–¢–µ–ª–µ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω']
    
    for card in sampled_cards:
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –ø–æ —ç—Ç–æ–π –∫–∞—Ä—Ç–µ
        card_data = df_112[df_112['–ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞“õ–∞–º–∏'] == card].iloc[0]
        
        # 20% - –∂–∞–ª–æ–±—ã, 70% - –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ, 10% - –Ω–µ –¥–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å
        rand = np.random.random()
        
        if rand < 0.2:  # 20% –∂–∞–ª–æ–±
            complaint = np.random.choice(complaints)
            positive = ''
            status = '–î–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å'
        elif rand < 0.9:  # 70% –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ
            complaint = ''
            positive = '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ'
            status = '–î–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å'
        else:  # 10% –Ω–µ –¥–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å
            complaint = ''
            positive = ''
            status = '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∑–≤–æ–Ω–∏—Ç—å—Å—è'
        
        record = [
            str(card),  # –ö–æ–ª–æ–Ω–∫–∞_2 - –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
            str(card_data.get('–ú—É—à—Ç–∞—Ä–∏–π –¢–µ–ª–µ—Ñ–æ–Ω –†–∞“õ–∞–º–∏', '')),  # –ö–æ–ª–æ–Ω–∫–∞_3 - —Ç–µ–ª–µ—Ñ–æ–Ω
            str(card_data.get('–ú—É—à—Ç–∞—Ä–∏–π –º—É–≤–∞–∂–∂–∏–∞—Ç –í–∞“õ—Ç', '')),  # –ö–æ–ª–æ–Ω–∫–∞_4 - –¥–∞—Ç–∞/–≤—Ä–µ–º—è
            str(card_data.get('–•—É–¥—É–¥', '')),  # –ö–æ–ª–æ–Ω–∫–∞_5 - —Ä–µ–≥–∏–æ–Ω
            str(card_data.get('–¢—É–º–∞–Ω', '')),  # –ö–æ–ª–æ–Ω–∫–∞_6 - —Ä–∞–π–æ–Ω
            str(int(card_data.get('–•–∏–∑–º–∞—Ç', 0))),  # –ö–æ–ª–æ–Ω–∫–∞_7 - —Å–ª—É–∂–±–∞
            complaint,  # –ö–æ–ª–æ–Ω–∫–∞_8 - –∂–∞–ª–æ–±–∞
            positive,  # –ö–æ–ª–æ–Ω–∫–∞_9 - –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ
            status,  # –ö–æ–ª–æ–Ω–∫–∞_10 - —Å—Ç–∞—Ç—É—Å
            '',  # –ö–æ–ª–æ–Ω–∫–∞_11
            '',  # –ö–æ–ª–æ–Ω–∫–∞_12
            '–¢–ï–°–¢–û–í–´–ô_–î–û–ö–£–ú–ï–ù–¢',  # –î–æ–∫—É–º–µ–Ω—Ç
            '–¢–ï–°–¢',  # –õ–∏—Å—Ç
            'TEST_DOC_ID',  # ID_–î–æ–∫—É–º–µ–Ω—Ç–∞
            len(records) + 2  # –ù–æ–º–µ—Ä_–°—Ç—Ä–æ–∫–∏
        ]
        
        records.append(record)
    
    print(f"‚úì –°–æ–∑–¥–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: {len(records)}")
    
    # –°–æ–∑–¥–∞—ë–º DataFrame
    print("\n[4/4] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...")
    columns = [
        '–ö–æ–ª–æ–Ω–∫–∞_2', '–ö–æ–ª–æ–Ω–∫–∞_3', '–ö–æ–ª–æ–Ω–∫–∞_4', '–ö–æ–ª–æ–Ω–∫–∞_5', '–ö–æ–ª–æ–Ω–∫–∞_6',
        '–ö–æ–ª–æ–Ω–∫–∞_7', '–ö–æ–ª–æ–Ω–∫–∞_8', '–ö–æ–ª–æ–Ω–∫–∞_9', '–ö–æ–ª–æ–Ω–∫–∞_10', '–ö–æ–ª–æ–Ω–∫–∞_11', '–ö–æ–ª–æ–Ω–∫–∞_12',
        '–î–æ–∫—É–º–µ–Ω—Ç', '–õ–∏—Å—Ç', 'ID_–î–æ–∫—É–º–µ–Ω—Ç–∞', '–ù–æ–º–µ—Ä_–°—Ç—Ä–æ–∫–∏'
    ]
    
    df = pd.DataFrame(records, columns=columns)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    timestamp = datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
    output_file = Path('data') / f'–¢–ï–°–¢–û–í–´–ï_–î–ê–ù–ù–´–ï_–°_–ñ–ê–õ–û–ë–ê–ú–ò_{timestamp}.csv'
    df.to_csv(output_file, index=False, encoding='utf-8-sig')
    
    print(f"‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {output_file}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("\n" + "="*80)
    print("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê")
    print("="*80)
    
    complaints_count = df[df['–ö–æ–ª–æ–Ω–∫–∞_8'].str.len() > 0].shape[0]
    positive_count = df[df['–ö–æ–ª–æ–Ω–∫–∞_9'] == '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ'].shape[0]
    no_answer_count = df[df['–ö–æ–ª–æ–Ω–∫–∞_10'] == '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∑–≤–æ–Ω–∏—Ç—å—Å—è'].shape[0]
    
    print(f"\n–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(df)}")
    print(f"\nüìå –ñ–∞–ª–æ–±—ã: {complaints_count} ({complaints_count/len(df)*100:.1f}%)")
    print(f"‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ: {positive_count} ({positive_count/len(df)*100:.1f}%)")
    print(f"üìû –ù–µ –¥–æ–∑–≤–æ–Ω–∏–ª–∏—Å—å: {no_answer_count} ({no_answer_count/len(df)*100:.1f}%)")
    
    if complaints_count > 0:
        print("\n–¢–æ–ø-5 –∂–∞–ª–æ–±:")
        for complaint, count in df[df['–ö–æ–ª–æ–Ω–∫–∞_8'].str.len() > 0]['–ö–æ–ª–æ–Ω–∫–∞_8'].value_counts().head().items():
            print(f"  ‚Ä¢ {complaint}: {count}")
    
    print("\n" + "="*80)
    print("‚úÖ –ì–û–¢–û–í–û!")
    print("="*80)
    print(f"\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print(f"   {output_file.name}")
    print(f"\n‚ö†Ô∏è  –î–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å—Ç–∏—Ç–µ import_sheets_consolidated.py")
    print(f"   –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Google Sheets!")
    
    return output_file

if __name__ == '__main__':
    generate_test_complaints()
