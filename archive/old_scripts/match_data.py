#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
=============================================================================
–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•: GOOGLE SHEETS ‚Üî –ó–ê–Ø–í–ö–ò 112
=============================================================================
–°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –∑–∞—è–≤–∫–∞—Ö –∏–∑ —Å–ª—É–∂–±—ã 112
=============================================================================
"""

import pandas as pd
from pathlib import Path
from datetime import datetime
import numpy as np

BASE_DIR = Path(__file__).parent

print('\n' + '='*80)
print('üîÑ –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•: GOOGLE SHEETS ‚Üî –ó–ê–Ø–í–ö–ò 112')
print('='*80)

# =============================================================================
# –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
# =============================================================================

print('\n[1/5] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...')

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
data_dir = BASE_DIR / 'data'
sheets_files = list(data_dir.glob('–ö–û–ù–°–û–õ–ò–î–ò–†–û–í–ê–ù–ù–´–ï_–î–ê–ù–ù–´–ï_*.csv'))

if not sheets_files:
    print('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets')
    exit(1)

sheets_file = max(sheets_files, key=lambda p: p.stat().st_mtime)
print(f'  Google Sheets: {sheets_file.name}')
df_sheets = pd.read_csv(sheets_file, encoding='utf-8-sig')
print(f'    –ó–∞–ø–∏—Å–µ–π: {len(df_sheets):,}')

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞—è–≤–∫–∞—Ö 112
calls_files = list(data_dir.glob('–ò–°–¢–û–†–ò–Ø_–ó–í–û–ù–ö–û–í_112_–û–ë–™–ï–î–ò–ù–Å–ù–ù–ê–Ø_*.csv'))

if not calls_files:
    print('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –∑–∞—è–≤–∫–∞—Ö 112')
    exit(1)

calls_file = max(calls_files, key=lambda p: p.stat().st_mtime)
print(f'  –ó–∞—è–≤–∫–∏ 112: {calls_file.name}')
df_calls = pd.read_csv(calls_file, encoding='utf-8-sig', low_memory=False)
print(f'    –ó–∞–ø–∏—Å–µ–π: {len(df_calls):,}')

# =============================================================================
# –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•
# =============================================================================

print('\n[2/5] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è...')

# –î–ª—è Google Sheets - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
df_sheets['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm'] = df_sheets['–ö–æ–ª–æ–Ω–∫–∞_2'].astype(str).str.strip().str.upper()
df_sheets['–¢–µ–ª–µ—Ñ–æ–Ω_norm'] = df_sheets['–ö–æ–ª–æ–Ω–∫–∞_3'].astype(str).str.replace(r'\D', '', regex=True)

# –î–ª—è –∑–∞—è–≤–æ–∫ 112 - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
df_calls['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm'] = df_calls['–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏'].astype(str).str.strip().str.upper()
df_calls['–¢–µ–ª–µ—Ñ–æ–Ω_–∑–∞—è–≤–∏—Ç–µ–ª—è_norm'] = df_calls['–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∑–∞—è–≤–∏—Ç–µ–ª—è'].astype(str).str.replace(r'\D', '', regex=True)

print(f'  ‚úì –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç: {df_sheets["–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm"].notna().sum():,}')
print(f'  ‚úì –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç–µ–ª–µ—Ñ–æ–Ω—ã Sheets: {df_sheets["–¢–µ–ª–µ—Ñ–æ–Ω_norm"].notna().sum():,}')
print(f'  ‚úì –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ 112: {df_calls["–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm"].notna().sum():,}')
print(f'  ‚úì –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç–µ–ª–µ—Ñ–æ–Ω—ã 112: {df_calls["–¢–µ–ª–µ—Ñ–æ–Ω_–∑–∞—è–≤–∏—Ç–µ–ª—è_norm"].notna().sum():,}')

# =============================================================================
# –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ü–û –ù–û–ú–ï–†–£ –ö–ê–†–¢–´/–ö–ê–†–¢–û–ß–ö–ò
# =============================================================================

print('\n[3/5] –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã/–∫–∞—Ä—Ç–æ—á–∫–∏...')

# –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
df_sheets_cards = df_sheets[df_sheets['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm'].notna() & 
                             (df_sheets['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm'] != '') &
                             (df_sheets['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm'] != 'NAN')].copy()

df_calls_cards = df_calls[df_calls['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm'].notna() & 
                           (df_calls['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm'] != '') &
                           (df_calls['–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm'] != 'NAN')].copy()

# –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã
matched_by_card = pd.merge(
    df_sheets_cards,
    df_calls_cards,
    left_on='–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm',
    right_on='–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm',
    how='inner',
    suffixes=('_Sheets', '_112')
)

print(f'  ‚úì –°–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã: {len(matched_by_card):,}')

# =============================================================================
# –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ü–û –¢–ï–õ–ï–§–û–ù–£
# =============================================================================

print('\n[4/5] –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞...')

# –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã (–º–µ–Ω–µ–µ 9 —Ü–∏—Ñ—Ä)
df_sheets_phones = df_sheets[
    df_sheets['–¢–µ–ª–µ—Ñ–æ–Ω_norm'].notna() & 
    (df_sheets['–¢–µ–ª–µ—Ñ–æ–Ω_norm'].str.len() >= 9)
].copy()

df_calls_phones = df_calls[
    df_calls['–¢–µ–ª–µ—Ñ–æ–Ω_–∑–∞—è–≤–∏—Ç–µ–ª—è_norm'].notna() & 
    (df_calls['–¢–µ–ª–µ—Ñ–æ–Ω_–∑–∞—è–≤–∏—Ç–µ–ª—è_norm'].str.len() >= 9)
].copy()

# –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
matched_by_phone = pd.merge(
    df_sheets_phones,
    df_calls_phones,
    left_on='–¢–µ–ª–µ—Ñ–æ–Ω_norm',
    right_on='–¢–µ–ª–µ—Ñ–æ–Ω_–∑–∞—è–≤–∏—Ç–µ–ª—è_norm',
    how='inner',
    suffixes=('_Sheets', '_112')
)

print(f'  ‚úì –°–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: {len(matched_by_phone):,}')

# =============================================================================
# –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# =============================================================================

print('\n[5/5] –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...')

# –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
all_matches = pd.concat([matched_by_card, matched_by_phone], ignore_index=True)
all_matches = all_matches.drop_duplicates()

print(f'  ‚úì –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(all_matches):,}')

# =============================================================================
# –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# =============================================================================

timestamp = datetime.now().strftime('%Y-%m-%d_%H-%M')

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
matches_file = BASE_DIR / 'data' / f'–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï_–ü–û–õ–ù–û–ï_{timestamp}.csv'
all_matches.to_csv(matches_file, index=False, encoding='utf-8-sig')
print(f'\n‚úÖ –ü–æ–ª–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: {matches_file.name}')

# –°–æ–∑–¥–∞—ë–º —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Å –∫–ª—é—á–µ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
key_columns = [
    '–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç—ã_norm', '–¢–µ–ª–µ—Ñ–æ–Ω_norm', '–ö–æ–ª–æ–Ω–∫–∞_4', '–ö–æ–ª–æ–Ω–∫–∞_5', 
    '–ö–æ–ª–æ–Ω–∫–∞_8', '–î–æ–∫—É–º–µ–Ω—Ç', '–õ–∏—Å—Ç',
    '–ù–æ–º–µ—Ä_–∫–∞—Ä—Ç–æ—á–∫–∏_norm', '–ù–æ–º–µ—Ä –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞', '–î–∞—Ç–∞', '–°–ª—É–∂–±–∞', 
    '–°—Ç–∞—Ç—É—Å', '–û–ø–µ—Ä–∞—Ç–æ—Ä', '–†–∞–π–æ–Ω', '–ê–¥—Ä–µ—Å'
]

existing_cols = [col for col in key_columns if col in all_matches.columns]
summary_matches = all_matches[existing_cols].copy()

summary_file = BASE_DIR / 'data' / f'–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï_–°–í–û–î–ö–ê_{timestamp}.csv'
summary_matches.to_csv(summary_file, index=False, encoding='utf-8-sig')
print(f'‚úÖ –°–≤–æ–¥–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {summary_file.name}')

# =============================================================================
# –°–û–ó–î–ê–ù–ò–ï –û–¢–ß–Å–¢–ê
# =============================================================================

report_file = BASE_DIR / 'reports' / f'–û–¢–ß–Å–¢_–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï_{timestamp}.txt'

with open(report_file, 'w', encoding='utf-8') as f:
    f.write('='*80 + '\n')
    f.write('–û–¢–ß–Å–¢ –ü–û –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Æ –î–ê–ù–ù–´–•\n')
    f.write('='*80 + '\n')
    f.write(f'–î–∞—Ç–∞: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n')
    f.write('='*80 + '\n\n')
    
    f.write('üìä –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï\n')
    f.write('-'*80 + '\n')
    f.write(f'Google Sheets (–∞–≥–µ–Ω—Ç—ã):     {len(df_sheets):>10,} –∑–∞–ø–∏—Å–µ–π\n')
    f.write(f'–ó–∞—è–≤–∫–∏ 112:                 {len(df_calls):>10,} –∑–∞–ø–∏—Å–µ–π\n\n')
    
    f.write('='*80 + '\n')
    f.write('üîç –†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø\n')
    f.write('='*80 + '\n\n')
    
    f.write('–ü–û –ù–û–ú–ï–†–£ –ö–ê–†–¢–´/–ö–ê–†–¢–û–ß–ö–ò:\n')
    f.write(f'  –°–æ–≤–ø–∞–¥–µ–Ω–∏–π:               {len(matched_by_card):>10,}\n')
    f.write(f'  % –æ—Ç Sheets:              {len(matched_by_card)/len(df_sheets)*100:>10.2f}%\n')
    f.write(f'  % –æ—Ç –∑–∞—è–≤–æ–∫ 112:          {len(matched_by_card)/len(df_calls)*100:>10.2f}%\n\n')
    
    f.write('–ü–û –ù–û–ú–ï–†–£ –¢–ï–õ–ï–§–û–ù–ê:\n')
    f.write(f'  –°–æ–≤–ø–∞–¥–µ–Ω–∏–π:               {len(matched_by_phone):>10,}\n')
    f.write(f'  % –æ—Ç Sheets:              {len(matched_by_phone)/len(df_sheets)*100:>10.2f}%\n')
    f.write(f'  % –æ—Ç –∑–∞—è–≤–æ–∫ 112:          {len(matched_by_phone)/len(df_calls)*100:>10.2f}%\n\n')
    
    f.write('–í–°–ï–ì–û –£–ù–ò–ö–ê–õ–¨–ù–´–• –°–û–í–ü–ê–î–ï–ù–ò–ô:\n')
    f.write(f'  –ó–∞–ø–∏—Å–µ–π:                  {len(all_matches):>10,}\n')
    f.write(f'  % –æ—Ç Sheets:              {len(all_matches)/len(df_sheets)*100:>10.2f}%\n')
    f.write(f'  % –æ—Ç –∑–∞—è–≤–æ–∫ 112:          {len(all_matches)/len(df_calls)*100:>10.2f}%\n\n')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
    if '–î–æ–∫—É–º–µ–Ω—Ç' in all_matches.columns:
        f.write('='*80 + '\n')
        f.write('üìÅ –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –î–û–ö–£–ú–ï–ù–¢–ê–ú\n')
        f.write('='*80 + '\n\n')
        
        doc_stats = all_matches['–î–æ–∫—É–º–µ–Ω—Ç'].value_counts()
        for idx, (doc, count) in enumerate(doc_stats.head(20).items(), 1):
            f.write(f'{idx:3}. {doc:<50} - {count:>6,} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π\n')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ª—É–∂–±–∞–º
    if '–°–ª—É–∂–±–∞' in all_matches.columns:
        f.write('\n' + '='*80 + '\n')
        f.write('üöë –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –°–õ–£–ñ–ë–ê–ú\n')
        f.write('='*80 + '\n\n')
        
        service_stats = all_matches['–°–ª—É–∂–±–∞'].value_counts()
        for service, count in service_stats.items():
            f.write(f'{service:<20} - {count:>8,} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π\n')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    if '–°—Ç–∞—Ç—É—Å' in all_matches.columns:
        f.write('\n' + '='*80 + '\n')
        f.write('üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –°–¢–ê–¢–£–°–ê–ú\n')
        f.write('='*80 + '\n\n')
        
        status_stats = all_matches['–°—Ç–∞—Ç—É—Å'].value_counts()
        for idx, (status, count) in enumerate(status_stats.head(10).items(), 1):
            f.write(f'{idx:3}. {status:<50} - {count:>6,}\n')
    
    f.write('\n' + '='*80 + '\n')
    f.write('‚úÖ –û–¢–ß–Å–¢ –ó–ê–í–ï–†–®–Å–ù\n')
    f.write('='*80 + '\n')

print(f'‚úÖ –û—Ç—á—ë—Ç: {report_file.name}')

# =============================================================================
# –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# =============================================================================

print('\n' + '='*80)
print('üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø')
print('='*80)
print(f'\n–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:')
print(f'  Google Sheets:        {len(df_sheets):>10,} –∑–∞–ø–∏—Å–µ–π')
print(f'  –ó–∞—è–≤–∫–∏ 112:           {len(df_calls):>10,} –∑–∞–ø–∏—Å–µ–π')
print(f'\n–°–æ–≤–ø–∞–¥–µ–Ω–∏—è:')
print(f'  –ü–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã:      {len(matched_by_card):>10,} ({len(matched_by_card)/len(df_sheets)*100:.2f}%)')
print(f'  –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É:          {len(matched_by_phone):>10,} ({len(matched_by_phone)/len(df_sheets)*100:.2f}%)')
print(f'  –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö:     {len(all_matches):>10,} ({len(all_matches)/len(df_sheets)*100:.2f}%)')

if '–°–ª—É–∂–±–∞' in all_matches.columns:
    print(f'\n–ü–æ —Å–ª—É–∂–±–∞–º:')
    service_stats = all_matches['–°–ª—É–∂–±–∞'].value_counts()
    for service, count in service_stats.head(5).items():
        print(f'  {service}: {count:,}')

print('\n' + '='*80)
print('‚úÖ –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û')
print('='*80)
print(f'\nüìÑ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:')
print(f'  1. {matches_file.name}')
print(f'  2. {summary_file.name}')
print(f'  3. {report_file.name}')
print('\n' + '='*80)
