"""
–û–ë–†–ê–ë–û–¢–ö–ê –ò –ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–• (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê)
–ö–æ–ª–æ–Ω–∫–∏: –û–ø–µ—Ä–∞—Ç–æ—Ä | –ê—Ä—Ö–∏–≤–Ω—ã–π –ª–∏—Å—Ç | –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã | –¢–µ–ª–µ—Ñ–æ–Ω | –î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è | 
         –°—Ç–∞—Ç—É—Å | –°–ª—É–∂–±–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π | –û–ø–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–∫—Å. | –î–∞—Ç–∞ —Ñ–∏–∫—Å.
"""
import pandas as pd
import numpy as np
from datetime import datetime
import re

print("=" * 80)
print("–û–ë–†–ê–ë–û–¢–ö–ê –ò –ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•")
print("=" * 80)

# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
COLUMNS = [
    '–û–ø–µ—Ä–∞—Ç–æ—Ä',
    '–ê—Ä—Ö–∏–≤–Ω—ã–π –ª–∏—Å—Ç',
    '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã',
    '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
    '–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç—ã',
    '–°—Ç–∞—Ç—É—Å',
    '–°–ª—É–∂–±–∞',
    '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
    '–û–ø–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–≤—à–∏–π',
    '–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞—Ü–∏–∏'
]

# ============================================================================
# 1. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
# ============================================================================
print("\nüìñ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
df = pd.read_csv('ALL_DATA.csv', encoding='utf-8-sig', names=COLUMNS, skiprows=1)
print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(df):,} —Å—Ç—Ä–æ–∫")

# ============================================================================
# 2. –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–•
# ============================================================================
print("\nüßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")

# –£–¥–∞–ª—è–µ–º "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞"
before_count = len(df)
df = df[df['–°—Ç–∞—Ç—É—Å'] != '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞']
removed = before_count - len(df)
print(f"   –£–¥–∞–ª–µ–Ω–æ '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞': {removed:,} —Å—Ç—Ä–æ–∫")

# –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
print("   –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π...")
df['–û–ø–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–≤—à–∏–π'] = df['–û–ø–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–≤—à–∏–π'].ffill()
df['–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞—Ü–∏–∏'] = df['–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞—Ü–∏–∏'].ffill()

# ============================================================================
# 3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ú–ï–°–Ø–¶–ê
# ============================================================================
print("\nüìÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤...")

def extract_month(sheet_name):
    match = re.search(r'(\d{2})[./](\d{4})', str(sheet_name))
    if match:
        return f"{match.group(2)}-{match.group(1)}"
    match = re.search(r'(\d{4})', str(sheet_name))
    if match:
        return match.group(1)
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

df['–ú–µ—Å—è—Ü'] = df['–ê—Ä—Ö–∏–≤–Ω—ã–π –ª–∏—Å—Ç'].apply(extract_month)

# ============================================================================
# 4. –°–í–û–î–ö–ê –ü–û –°–¢–ê–¢–£–°–ê–ú
# ============================================================================
print("\nüìä –°–í–û–î–ö–ê –ü–û –°–¢–ê–¢–£–°–ê–ú (–¢–û–ü-20)")
print("=" * 80)

status_counts = df['–°—Ç–∞—Ç—É—Å'].value_counts()
total = len(df)

for status, count in status_counts.head(20).items():
    pct = (count / total) * 100
    print(f"{status:<50} {count:>12,} ({pct:>5.2f}%)")

# ============================================================================
# 5. –°–í–û–î–ö–ê –ü–û –°–õ–£–ñ–ë–ê–ú
# ============================================================================
print("\nüìä –°–í–û–î–ö–ê –ü–û –°–õ–£–ñ–ë–ê–ú (–¢–û–ü-20)")
print("=" * 80)

service_counts = df['–°–ª—É–∂–±–∞'].value_counts()
for service, count in service_counts.head(20).items():
    pct = (count / total) * 100
    print(f"{str(service):<50} {count:>12,} ({pct:>5.2f}%)")

# ============================================================================
# 6. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –û–ü–ï–†–ê–¢–û–†–ê–ú
# ============================================================================
print("\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –û–ü–ï–†–ê–¢–û–†–ê–ú")
print("=" * 80)

operator_stats = df.groupby('–û–ø–µ—Ä–∞—Ç–æ—Ä')['–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã'].count().sort_values(ascending=False)
for op, count in operator_stats.items():
    print(f"{op:<40} {count:>12,}")

# ============================================================================
# 7. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ú–ï–°–Ø–¶–ê–ú
# ============================================================================
print("\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ú–ï–°–Ø–¶–ê–ú")
print("=" * 80)

month_stats = df.groupby('–ú–µ—Å—è—Ü')['–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã'].count().sort_index(ascending=False)
for month, count in month_stats.items():
    print(f"{month:<20} {count:>12,}")

# ============================================================================
# 8. –°–û–•–†–ê–ù–ï–ù–ò–ï
# ============================================================================
print("\nüíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...")

with pd.ExcelWriter('–°–¢–ê–¢–ò–°–¢–ò–ö–ê.xlsx', engine='openpyxl') as writer:
    # –°—Ç–∞—Ç—É—Å—ã
    pd.DataFrame({
        '–°—Ç–∞—Ç—É—Å': status_counts.head(100).index,
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': status_counts.head(100).values,
        '–ü—Ä–æ—Ü–µ–Ω—Ç': (status_counts.head(100).values / total * 100).round(2)
    }).to_excel(writer, sheet_name='–ü–æ —Å—Ç–∞—Ç—É—Å–∞–º', index=False)
    
    # –°–ª—É–∂–±—ã
    pd.DataFrame({
        '–°–ª—É–∂–±–∞': service_counts.head(100).index,
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': service_counts.head(100).values,
        '–ü—Ä–æ—Ü–µ–Ω—Ç': (service_counts.head(100).values / total * 100).round(2)
    }).to_excel(writer, sheet_name='–ü–æ —Å–ª—É–∂–±–∞–º', index=False)
    
    # –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
    pd.DataFrame({
        '–û–ø–µ—Ä–∞—Ç–æ—Ä': operator_stats.index,
        '–ó–∞–ø–∏—Å–µ–π': operator_stats.values
    }).to_excel(writer, sheet_name='–ü–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º', index=False)
    
    # –ú–µ—Å—è—Ü—ã
    pd.DataFrame({
        '–ú–µ—Å—è—Ü': month_stats.index,
        '–ó–∞–ø–∏—Å–µ–π': month_stats.values
    }).to_excel(writer, sheet_name='–ü–æ –º–µ—Å—è—Ü–∞–º', index=False)

print("‚úÖ –°–¢–ê–¢–ò–°–¢–ò–ö–ê.xlsx")

df.to_csv('ALL_DATA_CLEANED.csv', index=False, encoding='utf-8-sig')
print("‚úÖ ALL_DATA_CLEANED.csv")

print("\n" + "=" * 80)
print("üìà –ò–¢–û–ì–û")
print("=" * 80)
print(f"–ó–∞–ø–∏—Å–µ–π: {len(df):,}")
print(f"–û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤: {df['–û–ø–µ—Ä–∞—Ç–æ—Ä'].nunique()}")
print(f"–ö–∞—Ä—Ç: {df['–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã'].nunique():,}")
print(f"–°—Ç–∞—Ç—É—Å–æ–≤: {df['–°—Ç–∞—Ç—É—Å'].nunique()}")
print(f"–°–ª—É–∂–±: {df['–°–ª—É–∂–±–∞'].nunique()}")
print("\n‚úÖ –ì–û–¢–û–í–û!")
