@echo off
chcp 65001 >nul
title Полный цикл: Импорт и обработка данных в PostgreSQL

echo ================================================================================
echo         ПОЛНЫЙ ЦИКЛ: ИМПОРТ И ОБРАБОТКА ДАННЫХ
echo ================================================================================
echo.
echo Этот скрипт выполнит:
echo   1. Импорт данных из Google Sheets в PostgreSQL
echo   2. Обработку данных  
echo   3. Создание отчетных таблиц в БД (без Excel файлов)
echo.
echo ================================================================================
echo.

REM Шаг 1: Импорт данных
echo [ШАГ 1/2] Импорт данных из Google Sheets...
echo --------------------------------------------------------------------------------
call .venv\Scripts\activate.bat
set PYTHONIOENCODING=utf-8
python scripts\database\import_all_sheets_filtered.py

if errorlevel 1 (
    echo.
    echo ❌ ОШИБКА при импорте данных!
    pause
    exit /b 1
)

echo.
echo ✅ Импорт данных завершен
echo.

REM Шаг 2: Обработка и сохранение в БД
echo [ШАГ 2/2] Обработка данных и сохранение в БД...
echo --------------------------------------------------------------------------------
python process_and_save_to_db.py

if errorlevel 1 (
    echo.
    echo ❌ ОШИБКА при обработке данных!
    pause
    exit /b 1
)

echo.
echo ================================================================================
echo ✅ ПОЛНЫЙ ЦИКЛ УСПЕШНО ЗАВЕРШЕН!
echo ================================================================================
echo.
echo Созданные таблицы в PostgreSQL:
echo   • detailed_reports - детальные отчеты
echo   • negative_complaints - отрицательные отзывы и жалобы
echo   • complaints_by_region - сводка по регионам
echo   • regions_complaints_pivot - pivot таблица регионы-жалобы
echo   • not_found_applications - не найденные заявки
echo.
echo Для просмотра данных используйте SQL запросы к БД.
echo ================================================================================
echo.
pause
