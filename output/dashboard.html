<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QAyta - –î–∞—à–±–æ—Ä–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .controls h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-item label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        
        .filter-item select,
        .filter-item input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            transition: all 0.3s;
            min-width: 200px;
        }
        
        .filter-item select:focus,
        .filter-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 23px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            color: #667eea;
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table-container h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        
        table th:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8d 100%);
        }
        
        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        table tr:hover {
            background: #f8f9ff;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }
        
        .error {
            background: #ff4757;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            height: 400px;
        }
        
        #fileInput {
            display: none;
        }
        
        .upload-btn {
            background: #4cd964;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #3db84d;
            transform: translateY(-2px);
        }
        
        .tabs {
            background: white;
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9ff;
            border-bottom: 2px solid #eee;
        }
        
        .tab-button {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .tab-button.active {
            color: #667eea;
            background: white;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä QAyta - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</h1>
            <div class="subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</div>
        </div>
        
        <div class="controls">
            <h3>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
            <label for="fileInput" class="upload-btn">
                üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª ALL_DATA_FIXED.csv
            </label>
            <input type="file" id="fileInput" accept=".csv">
            <span id="fileName" style="margin-left: 20px; color: #666;"></span>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="content" style="display: none;">
            <div class="controls">
                <h3>üîç –§–∏–ª—å—Ç—Ä—ã</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä:</label>
                        <select id="operatorFilter">
                            <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>–ú–µ—Å—è—Ü:</label>
                        <select id="monthFilter">
                            <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>–°–ª—É–∂–±–∞:</label>
                        <select id="serviceFilter">
                            <option value="">–í—Å–µ —Å–ª—É–∂–±—ã</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã:</label>
                        <input type="text" id="cardSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã">
                    </div>
                    <button class="btn" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn" onclick="resetFilters()" style="background: #ff6b6b;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
                    <div class="value" id="totalCards">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</div>
                    <div class="value" id="uniqueCards">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">–û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</div>
                    <div class="value" id="totalOperators">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">–ü–µ—Ä–∏–æ–¥</div>
                    <div class="value" id="datePeriod" style="font-size: 1.2em;">-</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('operators')">üë• –û–ø–µ—Ä–∞—Ç–æ—Ä—ã</button>
                    <button class="tab-button" onclick="switchTab('monthsOpen')">üìÖ –ú–µ—Å—è—Ü—ã –æ—Ç–∫—Ä—ã—Ç–∏—è</button>
                    <button class="tab-button" onclick="switchTab('monthsFix')">üìå –ú–µ—Å—è—Ü—ã —Ñ–∏–∫—Å–∞—Ü–∏–∏</button>
                    <button class="tab-button" onclick="switchTab('services')">üîß –°–ª—É–∂–±—ã</button>
                    <button class="tab-button" onclick="switchTab('statuses')">üìä –°—Ç–∞—Ç—É—Å—ã</button>
                    <button class="tab-button" onclick="switchTab('positive')">‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ</button>
                    <button class="tab-button" onclick="switchTab('negative')">‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ</button>
                </div>
                
                <div id="tab-operators" class="tab-content active">
                    <h2>üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º</h2>
                    <table id="operatorTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'operatorTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'operatorTable')">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                <th onclick="sortTable(2, 'operatorTable')">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(3, 'operatorTable')">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</th>
                                <th onclick="sortTable(4, 'operatorTable')">% –æ—Ç –æ–±—â–µ–≥–æ</th>
                                <th onclick="sortTable(5, 'operatorTable')">–ü–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã</th>
                            </tr>
                        </thead>
                        <tbody id="operatorTableBody"></tbody>
                    </table>
                </div>
                
                <div id="tab-monthsOpen" class="tab-content">
                    <h2>üìÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç</h2>
                    <table id="monthOpenTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'monthOpenTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'monthOpenTable')">–ú–µ—Å—è—Ü</th>
                                <th onclick="sortTable(2, 'monthOpenTable')">–ó–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(3, 'monthOpenTable')">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</th>
                                <th onclick="sortTable(4, 'monthOpenTable')">–û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</th>
                                <th onclick="sortTable(5, 'monthOpenTable')">–°–ª—É–∂–±</th>
                            </tr>
                        </thead>
                        <tbody id="monthOpenTableBody"></tbody>
                    </table>
                </div>
                
                <div id="tab-monthsFix" class="tab-content">
                    <h2>üìå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º —Ñ–∏–∫—Å–∞—Ü–∏–∏</h2>
                    <table id="monthFixTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'monthFixTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'monthFixTable')">–ú–µ—Å—è—Ü</th>
                                <th onclick="sortTable(2, 'monthFixTable')">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –∑–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(3, 'monthFixTable')">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</th>
                                <th onclick="sortTable(4, 'monthFixTable')">–û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</th>
                                <th onclick="sortTable(5, 'monthFixTable')">–°–ª—É–∂–±</th>
                            </tr>
                        </thead>
                        <tbody id="monthFixTableBody"></tbody>
                    </table>
                </div>
                
                <div id="tab-services" class="tab-content">
                    <h2>üîß –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ª—É–∂–±–∞–º</h2>
                    <table id="serviceTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'serviceTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'serviceTable')">–°–ª—É–∂–±–∞</th>
                                <th onclick="sortTable(2, 'serviceTable')">–ó–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(3, 'serviceTable')">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</th>
                                <th onclick="sortTable(4, 'serviceTable')">% –æ—Ç –æ–±—â–µ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody id="serviceTableBody"></tbody>
                    </table>
                </div>
                
                <div id="tab-statuses" class="tab-content">
                    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
                    <table id="statusTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'statusTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'statusTable')">–°—Ç–∞—Ç—É—Å</th>
                                <th onclick="sortTable(2, 'statusTable')">–ó–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(3, 'statusTable')">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</th>
                                <th onclick="sortTable(4, 'statusTable')">% –æ—Ç –æ–±—â–µ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody"></tbody>
                    </table>
                </div>
                
                <div id="tab-positive" class="tab-content">
                    <h2>‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="label">–í—Å–µ–≥–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö</div>
                                <div class="value" id="positiveTotal">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</div>
                                <div class="value" id="positiveCards">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤</div>
                                <div class="value" id="positiveStatuses">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">% –æ—Ç –æ–±—â–µ–≥–æ</div>
                                <div class="value" id="positivePercent">0%</div>
                            </div>
                        </div>
                    </div>
                    <table id="positiveTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'positiveTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'positiveTable')">–ú–µ—Å—è—Ü</th>
                                <th onclick="sortTable(2, 'positiveTable')">–°–ª—É–∂–±–∞</th>
                                <th onclick="sortTable(3, 'positiveTable')">–°—Ç–∞—Ç—É—Å</th>
                                <th onclick="sortTable(4, 'positiveTable')">–ó–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(5, 'positiveTable')">–û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</th>
                                <th onclick="sortTable(6, 'positiveTable')">% –≤ –º–µ—Å—è—Ü–µ</th>
                            </tr>
                        </thead>
                        <tbody id="positiveTableBody"></tbody>
                    </table>
                </div>
                
                <div id="tab-negative" class="tab-content">
                    <h2>‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã - –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="label">–í—Å–µ–≥–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö</div>
                                <div class="value" id="negativeTotal">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç</div>
                                <div class="value" id="negativeCards">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                                <div class="value" id="negativeComments">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">% –æ—Ç –æ–±—â–µ–≥–æ</div>
                                <div class="value" id="negativePercent">0%</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="commentSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º..." 
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;"
                               onkeyup="filterNegativeByComment()">
                    </div>
                    <table id="negativeTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'negativeTable')">‚Ññ</th>
                                <th onclick="sortTable(1, 'negativeTable')">–ú–µ—Å—è—Ü</th>
                                <th onclick="sortTable(2, 'negativeTable')">–°–ª—É–∂–±–∞</th>
                                <th onclick="sortTable(3, 'negativeTable')">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                <th onclick="sortTable(4, 'negativeTable')">–ó–∞—è–≤–æ–∫</th>
                                <th onclick="sortTable(5, 'negativeTable')">% –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö</th>
                            </tr>
                        </thead>
                        <tbody id="negativeTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('content').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    parseCSV(event.target.result);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: ' + error.message;
                    document.getElementById('error').style.display = 'block';
                }
            };
            reader.readAsText(file, 'UTF-8');
        });
        
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            allData = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                if (values.length < 10) continue;
                
                const row = {
                    operator: values[0],
                    archiveSheet: values[1],
                    cardNumber: values[2],
                    phoneNumber: values[3],
                    openDate: values[4],
                    status: values[5],
                    service: values[6],
                    comment: values[7],
                    fixOperator: values[8],
                    fixDate: values[9]
                };
                
                allData.push(row);
            }
            
            filteredData = [...allData];
            populateFilters();
            updateStats();
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            
            return result;
        }
        
        function populateFilters() {
            // –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
            const operators = [...new Set(allData.map(d => d.operator))].sort();
            const operatorSelect = document.getElementById('operatorFilter');
            operatorSelect.innerHTML = '<option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>';
            operators.forEach(op => {
                operatorSelect.innerHTML += `<option value="${op}">${op}</option>`;
            });
            
            // –ú–µ—Å—è—Ü—ã
            const months = [...new Set(allData.map(d => extractMonth(d.openDate)))].filter(m => m).sort();
            const monthSelect = document.getElementById('monthFilter');
            monthSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>';
            months.forEach(month => {
                monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
            });
            
            // –°–ª—É–∂–±—ã
            const services = [...new Set(allData.map(d => d.service))].filter(s => s).sort();
            const serviceSelect = document.getElementById('serviceFilter');
            serviceSelect.innerHTML = '<option value="">–í—Å–µ —Å–ª—É–∂–±—ã</option>';
            services.forEach(service => {
                serviceSelect.innerHTML += `<option value="${service}">${service}</option>`;
            });
        }
        
        function extractMonth(dateStr) {
            if (!dateStr) return null;
            
            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
            const formats = [
                /(\d{2})\.(\d{2})\.(\d{4})/,  // DD.MM.YYYY
                /(\d{2})\/(\d{2})\/(\d{4})/,  // DD/MM/YYYY
                /(\d{4})-(\d{2})-(\d{2})/     // YYYY-MM-DD
            ];
            
            for (let format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    if (format === formats[2]) {
                        // YYYY-MM-DD
                        return `${match[1]}-${match[2]}`;
                    } else {
                        // DD.MM.YYYY –∏–ª–∏ DD/MM/YYYY
                        return `${match[3]}-${match[2]}`;
                    }
                }
            }
            
            return null;
        }
        
        function applyFilters() {
            const operatorFilter = document.getElementById('operatorFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const cardSearch = document.getElementById('cardSearch').value.toLowerCase();
            
            filteredData = allData.filter(row => {
                if (operatorFilter && row.operator !== operatorFilter) return false;
                if (monthFilter && extractMonth(row.openDate) !== monthFilter) return false;
                if (serviceFilter && row.service !== serviceFilter) return false;
                if (cardSearch && !row.cardNumber.toLowerCase().includes(cardSearch)) return false;
                return true;
            });
            
            updateStats();
        }
        
        function resetFilters() {
            document.getElementById('operatorFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('serviceFilter').value = '';
            document.getElementById('cardSearch').value = '';
            filteredData = [...allData];
            updateStats();
        }
        
        function switchTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function updateStats() {
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const totalCards = filteredData.length;
            const uniqueCards = new Set(filteredData.map(d => d.cardNumber)).size;
            const totalOperators = new Set(filteredData.map(d => d.operator)).size;
            
            document.getElementById('totalCards').textContent = totalCards.toLocaleString();
            document.getElementById('uniqueCards').textContent = uniqueCards.toLocaleString();
            document.getElementById('totalOperators').textContent = totalOperators;
            
            // –ü–µ—Ä–∏–æ–¥
            const dates = filteredData.map(d => d.openDate).filter(d => d);
            if (dates.length > 0) {
                const sortedDates = dates.sort();
                document.getElementById('datePeriod').textContent = 
                    `${sortedDates[0].split(' ')[0]} - ${sortedDates[sortedDates.length - 1].split(' ')[0]}`;
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
            updateOperatorTable();
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º –æ—Ç–∫—Ä—ã—Ç–∏—è
            updateMonthOpenTable();
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º —Ñ–∏–∫—Å–∞—Ü–∏–∏
            updateMonthFixTable();
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ª—É–∂–±–∞–º
            updateServiceTable();
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            updateStatusTable();
            
            // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ
            updatePositiveTable();
            updateNegativeTable();
        }
        
        function categorizeStatus(status) {
            if (!status) return '–ü—Ä–æ—á–µ–µ';
            const statusLower = status.toLowerCase();
            
            const positiveKeywords = ['–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω', 'qanoatlantir', '“õ–∞–Ω–æ–∞—Ç–ª–∞–Ω—Ç–∏—Ä'];
            for (let kw of positiveKeywords) {
                if (statusLower.includes(kw)) return '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π';
            }
            
            return '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π';
        }
        
        function updatePositiveTable() {
            const positiveData = filteredData.filter(row => categorizeStatus(row.status) === '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π');
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('positiveTotal').textContent = positiveData.length.toLocaleString();
            document.getElementById('positiveCards').textContent = new Set(positiveData.map(d => d.cardNumber)).size.toLocaleString();
            document.getElementById('positiveStatuses').textContent = new Set(positiveData.map(d => d.status)).size;
            const posPercent = filteredData.length > 0 ? ((positiveData.length / filteredData.length) * 100).toFixed(1) : 0;
            document.getElementById('positivePercent').textContent = posPercent + '%';
            
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º –∏ —Å–ª—É–∂–±–∞–º
            const grouped = {};
            positiveData.forEach(row => {
                const month = extractMonth(row.openDate) || '–ë–µ–∑ –¥–∞—Ç—ã';
                const service = row.service || '–ë–µ–∑ —Å–ª—É–∂–±—ã';
                const status = row.status || '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞';
                const key = `${month}|${service}|${status}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        month: month,
                        service: service,
                        status: status,
                        count: 0,
                        operators: new Set()
                    };
                }
                grouped[key].count++;
                grouped[key].operators.add(row.operator);
            });
            
            const tbody = document.getElementById('positiveTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.values(grouped).sort((a, b) => b.count - a.count);
            
            sorted.forEach((item, index) => {
                const [year, monthNum] = item.month.split('-');
                const monthNames = ['', '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                                   '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                const monthName = year && monthNum ? `${monthNames[parseInt(monthNum)]} ${year}` : item.month;
                
                // –ü—Ä–æ—Ü–µ–Ω—Ç –≤ –º–µ—Å—è—Ü–µ
                const monthData = positiveData.filter(r => extractMonth(r.openDate) === item.month);
                const monthPercent = monthData.length > 0 ? ((item.count / monthData.length) * 100).toFixed(1) : 0;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${monthName}</td>
                        <td><strong>${item.service}</strong></td>
                        <td>${item.status}</td>
                        <td>${item.count.toLocaleString()}</td>
                        <td>${item.operators.size}</td>
                        <td>
                            ${monthPercent}%
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${monthPercent}%; background: linear-gradient(90deg, #4cd964 0%, #2ecc71 100%);"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        let negativeFullData = [];
        
        function updateNegativeTable() {
            const negativeData = filteredData.filter(row => categorizeStatus(row.status) === '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π');
            negativeFullData = negativeData;
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('negativeTotal').textContent = negativeData.length.toLocaleString();
            document.getElementById('negativeCards').textContent = new Set(negativeData.map(d => d.cardNumber)).size.toLocaleString();
            document.getElementById('negativeComments').textContent = new Set(negativeData.map(d => d.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è')).size;
            const negPercent = filteredData.length > 0 ? ((negativeData.length / filteredData.length) * 100).toFixed(1) : 0;
            document.getElementById('negativePercent').textContent = negPercent + '%';
            
            renderNegativeTable(negativeData);
        }
        
        function filterNegativeByComment() {
            const searchText = document.getElementById('commentSearch').value.toLowerCase();
            if (!searchText) {
                renderNegativeTable(negativeFullData);
                return;
            }
            
            const filtered = negativeFullData.filter(row => {
                const comment = (row.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è').toLowerCase();
                return comment.includes(searchText);
            });
            
            renderNegativeTable(filtered);
        }
        
        function renderNegativeTable(negativeData) {
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º, —Å–ª—É–∂–±–∞–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º
            const grouped = {};
            negativeData.forEach(row => {
                const month = extractMonth(row.openDate) || '–ë–µ–∑ –¥–∞—Ç—ã';
                const service = row.service || '–ë–µ–∑ —Å–ª—É–∂–±—ã';
                const comment = row.comment && row.comment.trim() ? row.comment : '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è';
                const key = `${month}|${service}|${comment}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        month: month,
                        service: service,
                        comment: comment,
                        count: 0
                    };
                }
                grouped[key].count++;
            });
            
            const tbody = document.getElementById('negativeTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.values(grouped).sort((a, b) => b.count - a.count);
            const totalNegative = negativeData.length;
            
            sorted.forEach((item, index) => {
                const [year, monthNum] = item.month.split('-');
                const monthNames = ['', '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                                   '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                const monthName = year && monthNum ? `${monthNames[parseInt(monthNum)]} ${year}` : item.month;
                
                const percentage = totalNegative > 0 ? ((item.count / totalNegative) * 100).toFixed(2) : 0;
                
                // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                let displayComment = item.comment;
                if (displayComment.length > 100) {
                    displayComment = displayComment.substring(0, 100) + '...';
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${monthName}</td>
                        <td><strong>${item.service}</strong></td>
                        <td title="${item.comment}">${displayComment}</td>
                        <td>${item.count.toLocaleString()}</td>
                        <td>
                            ${percentage}%
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        function updateOperatorTable() {
            const operatorStats = {};
            
            filteredData.forEach(row => {
                if (!operatorStats[row.operator]) {
                    operatorStats[row.operator] = {
                        total: 0,
                        uniqueCards: new Set(),
                        dates: []
                    };
                }
                operatorStats[row.operator].total++;
                operatorStats[row.operator].uniqueCards.add(row.cardNumber);
                if (row.openDate) {
                    operatorStats[row.operator].dates.push(row.openDate);
                }
            });
            
            const tbody = document.getElementById('operatorTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(operatorStats).sort((a, b) => b[1].total - a[1].total);
            const totalCards = filteredData.length;
            
            sorted.forEach(([operator, stats], index) => {
                const percentage = ((stats.total / totalCards) * 100).toFixed(2);
                const dates = stats.dates.sort();
                const period = dates.length > 0 ? 
                    `${dates[0].split(' ')[0]} - ${dates[dates.length - 1].split(' ')[0]}` : '-';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${operator}</strong></td>
                        <td>${stats.total.toLocaleString()}</td>
                        <td>${stats.uniqueCards.size.toLocaleString()}</td>
                        <td>
                            ${percentage}%
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                        <td>${period}</td>
                    </tr>
                `;
            });
        }
        
        function updateMonthOpenTable() {
            const monthStats = {};
            
            filteredData.forEach(row => {
                const month = extractMonth(row.openDate);
                if (!month) return;
                
                if (!monthStats[month]) {
                    monthStats[month] = {
                        total: 0,
                        uniqueCards: new Set(),
                        operators: new Set(),
                        services: new Set()
                    };
                }
                monthStats[month].total++;
                monthStats[month].uniqueCards.add(row.cardNumber);
                monthStats[month].operators.add(row.operator);
                if (row.service) monthStats[month].services.add(row.service);
            });
            
            const tbody = document.getElementById('monthOpenTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(monthStats).sort((a, b) => b[0].localeCompare(a[0]));
            
            sorted.forEach(([month, stats], index) => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                                   '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                const monthName = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${monthName}</strong></td>
                        <td>${stats.total.toLocaleString()}</td>
                        <td>${stats.uniqueCards.size.toLocaleString()}</td>
                        <td>${stats.operators.size}</td>
                        <td>${stats.services.size}</td>
                    </tr>
                `;
            });
        }
        
        function updateMonthFixTable() {
            const monthStats = {};
            
            filteredData.forEach(row => {
                const month = extractMonth(row.fixDate);
                if (!month) return;
                
                if (!monthStats[month]) {
                    monthStats[month] = {
                        total: 0,
                        uniqueCards: new Set(),
                        operators: new Set(),
                        services: new Set()
                    };
                }
                monthStats[month].total++;
                monthStats[month].uniqueCards.add(row.cardNumber);
                monthStats[month].operators.add(row.fixOperator || row.operator);
                if (row.service) monthStats[month].services.add(row.service);
            });
            
            const tbody = document.getElementById('monthFixTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(monthStats).sort((a, b) => b[0].localeCompare(a[0]));
            
            sorted.forEach(([month, stats], index) => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                                   '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                const monthName = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${monthName}</strong></td>
                        <td>${stats.total.toLocaleString()}</td>
                        <td>${stats.uniqueCards.size.toLocaleString()}</td>
                        <td>${stats.operators.size}</td>
                        <td>${stats.services.size}</td>
                    </tr>
                `;
            });
        }
        
        function updateStatusTable() {
            const statusStats = {};
            
            filteredData.forEach(row => {
                if (!row.status) return;
                
                if (!statusStats[row.status]) {
                    statusStats[row.status] = {
                        total: 0,
                        uniqueCards: new Set()
                    };
                }
                statusStats[row.status].total++;
                statusStats[row.status].uniqueCards.add(row.cardNumber);
            });
            
            const tbody = document.getElementById('statusTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(statusStats).sort((a, b) => b[1].total - a[1].total);
            const totalCards = filteredData.length;
            
            sorted.forEach(([status, stats], index) => {
                const percentage = ((stats.total / totalCards) * 100).toFixed(2);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${status}</strong></td>
                        <td>${stats.total.toLocaleString()}</td>
                        <td>${stats.uniqueCards.size.toLocaleString()}</td>
                        <td>
                            ${percentage}%
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        function updateServiceTable() {
            const serviceStats = {};
            
            filteredData.forEach(row => {
                if (!row.service) return;
                
                if (!serviceStats[row.service]) {
                    serviceStats[row.service] = {
                        total: 0,
                        uniqueCards: new Set()
                    };
                }
                serviceStats[row.service].total++;
                serviceStats[row.service].uniqueCards.add(row.cardNumber);
            });
            
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(serviceStats).sort((a, b) => b[1].total - a[1].total);
            const totalCards = filteredData.length;
            
            sorted.forEach(([service, stats], index) => {
                const percentage = ((stats.total / totalCards) * 100).toFixed(2);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${service}</strong></td>
                        <td>${stats.total.toLocaleString()}</td>
                        <td>${stats.uniqueCards.size.toLocaleString()}</td>
                        <td>
                            ${percentage}%
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        function sortTable(column, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            rows.sort((a, b) => {
                const aVal = a.getElementsByTagName('td')[column].textContent;
                const bVal = b.getElementsByTagName('td')[column].textContent;
                
                // –ï—Å–ª–∏ —á–∏—Å–ª–∞
                if (!isNaN(parseFloat(aVal.replace(/,/g, ''))) && !isNaN(parseFloat(bVal.replace(/,/g, '')))) {
                    return parseFloat(bVal.replace(/,/g, '')) - parseFloat(aVal.replace(/,/g, ''));
                }
                
                return aVal.localeCompare(bVal);
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>