# 🤖 ПОЛНАЯ АВТОМАТИЗАЦИЯ СИСТЕМЫ

## ✅ ЧТО ТЕПЕРЬ РАБОТАЕТ АВТОМАТИЧЕСКИ

### 1. **Сбор данных FIKSA** (Column E Filtering)
- ✅ Подключается к Google Sheets
- ✅ Собирает **ТОЛЬКО записи где заполнен статус** (колонка E)
- ✅ Сохраняет в базу данных `fiksa_records`
- ✅ Обновляется каждый час

**Скрипт:** `scripts/data_collection/improved_collector.py`

### 2. **Статистика операторов**
- ✅ Автоматический расчет показателей каждого оператора
- ✅ Учитывается: всего записей, положительные, отрицательные, нет ответа, занято
- ✅ Ежедневное обновление таблицы `operator_stats_daily`
- ✅ Excel отчет с 8 колонками

**Таблица в БД:** `operator_stats_daily`  
**Отчет:** `reports/analytics/operator_performance_report.xlsx`

### 3. **Фидбэки от служб**
- ✅ Анализ ответов служб 102/103/104
- ✅ 3 листа в Excel:
  - Общая статистика по службам
  - Детализация по типам
  - Проблемные случаи (топ-500)
- ✅ Сохранение в таблицу `service_feedback`

**Отчет:** `reports/analytics/service_feedback_report.xlsx`

### 4. **Ответы граждан**
- ✅ Анализ всех типов ответов граждан
- ✅ Подсчет по категориям
- ✅ Процентное соотношение

**Отчет:** `reports/analytics/citizen_response_analysis.xlsx`

### 5. **Отчеты по службам (61 файл)**
- ✅ Соединение истории 112 + FIKSA + заявки
- ✅ Данные оператора FIKSA для каждого инцидента
- ✅ Автоматическая генерация для всех служб
- ✅ Отправка в Telegram

**Скрипт:** `scripts/analysis/service_reports.py`

---

## 🚀 КАК ЗАПУСТИТЬ АВТОМАТИЗАЦИЮ

### Вариант 1: Мастер-сервис (рекомендуется)
```bash
python scripts/automation/master_service.py
```

**Расписание:**
- **09:00** - Полный цикл (сбор + импорт + отчеты)
- **Каждый час** - Быстрая синхронизация FIKSA
- **Каждые 30 минут** - Показ текущей статистики

### Вариант 2: Ручной запуск отдельных модулей

#### Сбор данных FIKSA
```bash
python scripts/data_collection/improved_collector.py
```

#### Генерация аналитики
```bash
python scripts/analysis/analytics_reports.py
```

#### Отчеты по службам
```bash
python scripts/analysis/service_reports.py
```

---

## 📊 СТРУКТУРА БАЗЫ ДАННЫХ

### Таблица: `fiksa_records`
```sql
- id: INTEGER PRIMARY KEY
- collection_date: DATE
- operator_name: TEXT
- phone: TEXT
- full_name: TEXT         -- Номер инцидента
- call_date: DATE
- call_time: TIME
- service: TEXT           -- Служба (102/103/104)
- status: TEXT            -- ТОЛЬКО НЕПУСТЫЕ (фильтр по колонке E)
- notes: TEXT
- created_at: DATETIME
```

### Таблица: `operator_stats_daily`
```sql
- id: INTEGER PRIMARY KEY
- stat_date: DATE
- operator_name: TEXT
- total: INTEGER          -- Всего записей
- positive: INTEGER       -- Положительных
- negative: INTEGER       -- Отрицательных
- no_answer: INTEGER      -- Нет ответа
- busy: INTEGER           -- Занято
- created_at: DATETIME
```

### Таблица: `service_feedback`
```sql
- id: INTEGER PRIMARY KEY
- feedback_date: DATE
- service_type: TEXT      -- Тип службы
- feedback_category: TEXT -- Категория фидбэка
- count: INTEGER          -- Количество
- created_at: DATETIME
```

---

## 📁 СОЗДАВАЕМЫЕ ОТЧЕТЫ

### 1. Статистика операторов
**Файл:** `reports/analytics/operator_performance_report.xlsx`

| Колонка | Описание |
|---------|----------|
| Оператор | ФИО оператора |
| Всего | Всего обработано |
| Положительные | Успешные звонки |
| Отрицательные | Неуспешные |
| Нет ответа | Не ответили |
| Занято | Линия занята |
| % Успешных | Процент положительных |
| Дата | Дата статистики |

### 2. Фидбэки от служб
**Файл:** `reports/analytics/service_feedback_report.xlsx`

**Лист 1: Общая статистика**
- Служба, Всего записей, Проблемных, % Проблемных

**Лист 2: Детализация**
- Служба, Тип фидбэка, Количество, %

**Лист 3: Топ-500 проблемных**
- Дата, Время, Служба, Инцидент, Оператор, Статус, Примечания

### 3. Ответы граждан
**Файл:** `reports/analytics/citizen_response_analysis.xlsx`

| Тип ответа | Количество | % |
|------------|------------|---|
| Все типы ответов с процентным соотношением |

### 4. Отчеты по службам (61 файл)
**Папка:** `reports/services/`

Для каждой службы:
- История звонков 112
- Данные FIKSA (оператор, дата, телефон, примечания)
- Связанные заявки
- Автоматическая отправка в Telegram

---

## ⚙️ НАСТРОЙКА АВТОЗАПУСКА

### Windows (Task Scheduler)

1. Откройте "Планировщик заданий"
2. Создайте задачу:
   - **Имя:** "FIKSA Auto Collector"
   - **Триггер:** При запуске компьютера
   - **Действие:** 
     ```
     python.exe
     "C:\Users\a.djurayev\Desktop\QAyta skript\scripts\automation\master_service.py"
     ```

3. Настройки:
   - ✅ Выполнять, даже если пользователь не вошел в систему
   - ✅ Выполнять с наивысшими правами
   - ✅ Перезапускать при сбое каждые 5 минут

---

## 🔍 ЛОГИ И МОНИТОРИНГ

### Проверка статистики
```python
python -c "
import sqlite3
conn = sqlite3.connect('data/fiksa_database.db')
c = conn.cursor()
c.execute('SELECT COUNT(*) FROM fiksa_records')
print(f'FIKSA записей: {c.fetchone()[0]}')
c.execute('SELECT COUNT(*) FROM operator_stats_daily')
print(f'Статистика операторов: {c.fetchone()[0]}')
conn.close()
"
```

### Просмотр последних записей
```python
python -c "
import sqlite3
import pandas as pd
conn = sqlite3.connect('data/fiksa_database.db')
df = pd.read_sql_query(
    'SELECT * FROM fiksa_records ORDER BY created_at DESC LIMIT 10',
    conn
)
print(df[['collection_date', 'operator_name', 'service', 'status']])
conn.close()
"
```

---

## ✅ ФИЛЬТР ПО КОЛОНКЕ E

### Как это работает?

В `improved_collector.py` строки **101-104**:

```python
status = row[4] if len(row) > 4 else ''

# КРИТИЧЕСКИ ВАЖНО: Пропускаем записи БЕЗ статуса
if not status or status.strip() == '':
    continue  # Запись НЕ будет сохранена
```

### Результат:
- ❌ Пустые ячейки в колонке E → **НЕ СОХРАНЯЮТСЯ**
- ❌ Пробелы в колонке E → **НЕ СОХРАНЯЮТСЯ**
- ✅ Любое значение в колонке E → **СОХРАНЯЕТСЯ**

---

## 🎯 ИТОГОВАЯ СХЕМА РАБОТЫ

```
┌─────────────────────────────────────────────────────┐
│           GOOGLE SHEETS (FIKSA)                     │
│  Операторы → Листы данных → Колонка E (статус)     │
└──────────────────┬──────────────────────────────────┘
                   │
                   │ [Фильтр: только E заполнено]
                   ↓
┌─────────────────────────────────────────────────────┐
│         IMPROVED_COLLECTOR.PY                       │
│  • Собирает данные каждый час                       │
│  • Фильтрует по колонке E                           │
│  • Считает статистику операторов                    │
│  • Анализирует фидбэки служб                        │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────┐
│         SQLITE DATABASE                             │
│  • fiksa_records (13,070 записей)                   │
│  • operator_stats_daily (26 операторов)             │
│  • service_feedback (34 категории)                  │
└──────────────────┬──────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────┐
│         ANALYTICS_REPORTS.PY                        │
│  • Статистика операторов (Excel)                    │
│  • Фидбэки от служб (3 листа)                       │
│  • Ответы граждан                                   │
│  • Отправка в Telegram                              │
└─────────────────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────┐
│         SERVICE_REPORTS.PY                          │
│  • 61 отчет по службам                              │
│  • Соединение: 112 + FIKSA + Заявки                 │
│  • Данные оператора для каждого инцидента           │
│  • Telegram рассылка                                │
└─────────────────────────────────────────────────────┘
```

---

## 📞 ПОДДЕРЖКА

### Проблемы?

1. **Не собираются данные:**
   ```bash
   python scripts/data_collection/improved_collector.py
   ```
   Проверьте вывод на ошибки

2. **Не работает автоматизация:**
   ```bash
   python test_automation.py
   ```

3. **Не создаются отчеты:**
   ```bash
   python scripts/analysis/analytics_reports.py
   ```

---

## 🎉 ГОТОВО!

Система полностью автоматизирована:
- ✅ Сбор данных FIKSA с фильтром по колонке E
- ✅ Статистика операторов
- ✅ Анализ фидбэков служб
- ✅ Ответы граждан
- ✅ 61 отчет по службам
- ✅ Автоматическая отправка в Telegram
- ✅ Работает 24/7 в фоновом режиме

**Просто запустите:**
```bash
python scripts/automation/master_service.py
```

И система будет работать сама!
