# ЛОГИКА ОБРАБОТКИ ДАННЫХ - СЕССИЯ 02-03.02.2026

## КРАТКОЕ ОПИСАНИЕ

Система обрабатывает данные обращений в службу 112 (январь 2026, 4-31 число) и сопоставляет их с данными обзвона из Google Sheets для выявления жалоб и проблем по регионам и службам.

---

## ИСТОЧНИКИ ДАННЫХ

### 1. Файлы 112 (папка `123/`)
- 4 файла Excel с записями звонков в службу 112
- Формат: `ЧақирувТарихи_112_2026_01_04_00_00_00_2026_01_11_23_59_59.xlsx`
- Период: 04.01.2026 - 31.01.2026
- **Всего записей: 234,178**
- Службы: 101 (пожарная), 102 (полиция), 103 (скорая), 104 (газовая)

**Ключевые поля:**
- Инцидент_112 (Ҳодиса рақами) - уникальный номер инцидента
- Служба_112 (Хизмат) - номер службы (101/102/103/104)
- Регион_112 (Вилоят) - регион обращения
- Дата_112 (Сана) - дата и время обращения
- Телефон_112 (Мурожаатчи телефон рақами) - телефон заявителя

### 2. Google Sheets (файл `data/КОНСОЛИДИРОВАННЫЕ_ДАННЫЕ_*.csv`)
- Импортируются из 35 Google Sheets документов
- Содержит данные обзвона граждан после обращения в 112
- **Всего записей: 1,257,272** (все периоды)
- После фильтрации по датам 04-31.01.2026: ~200-250k записей

**Ключевые поля:**
- Колонка_2 (Инцидент_Sheets) - номер инцидента (связь с 112)
- Колонка_5 (Статус_связи) - результат обзвона (положительный/отрицательный)
- Колонка_6 (Служба_Sheets) - служба (может быть несколько через разделители)
- Колонка_7 (Жалоба) - текст жалобы, если есть
- Колонка_8 (Положительно) - имя оператора или положительный отзыв
- Импортирован (колонка L) - метка импорта (**Да**)

---

## КЛЮЧЕВАЯ ЛОГИКА СОПОСТАВЛЕНИЯ

### Правило 1: Сопоставление по номеру инцидента
```
Если номер_инцидента_112 == номер_инцидента_Sheets:
    → применяем данные из Sheets к записи 112
```

### Правило 2: Распределение жалоб по службам
```python
# Вариант А: Жалоба с указанием конкретной службы
Если в Sheets указана жалоба И указана служба (например, 102):
    → жалоба применяется ТОЛЬКО к записям службы 102 с этим инцидентом
    → другие службы (101, 103, 104) с тем же инцидентом НЕ получают жалобу

# Вариант Б: Жалоба без указания службы
Если в Sheets указана жалоба И служба НЕ указана:
    → жалоба применяется КО ВСЕМ службам с этим инцидентом
    → все записи 101/102/103/104 получают эту жалобу

# Вариант В: Несколько служб в Sheets
Если в Sheets указано "102, 103":
    → жалоба применяется только к службам 102 и 103
```

### Правило 3: Применение статусов
```
Статус_связи и Положительно применяются КО ВСЕМ службам по инциденту
(не зависят от указания конкретной службы)
```

---

## РЕАЛИЗАЦИЯ В КОДЕ

### Файл: `generate_service_reports_by_incident.py`

**Функция `load_sheets_maps()`:**
1. Читает CSV с данными Sheets чанками по 200k строк
2. Фильтрует по датам 04-31.01.2026
3. Создает 4 словаря:
   - `incident_status` - статус связи по инциденту
   - `incident_positive` - положительные отзывы по инциденту
   - `incident_all_complaints` - жалобы без указания службы
   - `incident_service_complaints` - жалобы с указанием службы

```python
# Пример структуры:
incident_service_complaints = {
    ('01.AAM0200/26', '102'): {'жалоба 1', 'жалоба 2'},
    ('01.AAM0201/26', '103'): {'жалоба 3'}
}

incident_all_complaints = {
    '01.AAM0300/26': {'жалоба без службы'}
}
```

**Функция `apply_sheets_data()`:**
1. Для каждой записи 112:
   - Берем номер инцидента и номер службы
   - Проверяем `incident_service_complaints[(инцидент, служба)]`
   - Если не нашли, проверяем `incident_all_complaints[инцидент]`
   - Применяем найденные жалобы
   - Применяем статус из `incident_status[инцидент]`

2. Устанавливает флаг `Есть_жалоба = True/False`

---

## СТРУКТУРА ВЫХОДНЫХ ОТЧЕТОВ

### Тип 1: Детальные отчеты по службам
**Папка:** `reports/2026-01_services_by_incident/`
**Файлы:** `СЛУЖБА_101_ИНЦИДЕНТЫ_*.xlsx` (4 файла)

**Листы:**
1. **Жалобы_по_регионам** - количество жалоб по каждому региону
2. **Регионы_и_жалобы** - сводка обращений и жалоб
3. **Детальные** - все записи службы с полями из 112 + Sheets
4. **Отрицательные_и_жалобы** - только проблемные записи

### Тип 2: Сводки и матрицы по службам
**Папка:** `reports/2026-01_services_by_incident_summary/`
**Файлы:** `СЛУЖБА_101_СВОДКА_И_МАТРИЦА_*.xlsx` (4 файла)

**Листы:**
1. **Сводка_количество:**
   - Всего_записей
   - Жалобы
   - Отрицательные (статусы с "не удалось дозвониться" и т.п.)
   - Отрицательные_или_жалобы

2. **Матрица_жалоб:**
   - Строки: регионы (все 14 регионов)
   - Столбцы: категории жалоб
   - Значения: количество
   - Последний столбец: ИТОГО

3. **Детальные:** все записи службы

### Тип 3: Общий отчет
**Папка:** `reports/2026-01_overall/`
**Файл:** `ОБЩИЙ_ОТЧЕТ_ВСЕ_СЛУЖБЫ_*.xlsx`

**Структура:** такая же, как у сводок (Сводка_количество, Матрица_жалоб, Детальные)
**Содержит:** все 234,178 записей по всем службам

---

## СТАТИСТИКА

### По службам:
- **Служба 101 (Пожарная):** 5,574 записей, 57 жалоб (1.0%)
- **Служба 102 (Полиция):** 158,343 записей, 7,967 жалоб (5.0%)
- **Служба 103 (Скорая):** 56,923 записей, 469 жалоб (0.8%)
- **Служба 104 (Газовая):** 13,338 записей, 878 жалоб (6.6%)

### Общая статистика:
- **Всего записей:** 234,178
- **С жалобами:** 9,371 (4.0%)
- **Регионов:** 14
- **Период:** 04.01.2026 - 31.01.2026

### Топ-5 регионов по жалобам:
1. ФАРҒОНА ВИЛОЯТИ - 1,585
2. СУРХОНДАРЁ ВИЛОЯТИ - 1,009
3. ҚАШҚАДАРЁ ВИЛОЯТИ - 995
4. ТОШКЕНТ ВИЛОЯТИ - 929
5. САМАРҚАНД ВИЛОЯТИ - 890

---

## ПРОВЕРКА КОРРЕКТНОСТИ

### Автоматическая проверка выполнена:
```python
✓ Детальные vs Сводка (Всего): совпадает
✓ Детальные vs Сводка (Жалобы): совпадает
✓ Матрица (ИТОГО) vs Жалобы: совпадает
✓ Сумма по 4 службам = источник 112: 234,178 = 234,178
```

### Сверка инцидентов:
- Уникальных инцидентов в Sheets: 729,494
- Уникальных инцидентов в 112: 218,718
- Совпадают: 203,554
- Только в Sheets: 525,940 (другие периоды, службы)
- Только в 112: 15,164 (нет обзвона)

Списки расхождений сохранены в:
- `output/incident_diff/only_in_sheets_*.csv`
- `output/incident_diff/only_in_112_*.csv`

---

## ФАЙЛЫ СКРИПТОВ

### Основные скрипты генерации отчетов:
1. **`generate_service_reports_by_incident.py`**
   - Создает 4 детальных отчета по службам
   - Полная логика сопоставления по инциденту

2. **`generate_service_reports_by_incident_summary.py`**
   - Создает 4 сводки + матрицы по службам
   - Использует функции из предыдущего скрипта

3. **`generate_overall_report_by_incident.py`**
   - Создает общий отчет по всем службам
   - Та же структура, что у сводок

### Вспомогательные скрипты:
- **`generate_112_reports_from_sheets.py`** - полный отчет 112 с жалобами
- **`import_with_service_account.py`** - импорт из Google Sheets
- **`process_period_data.py`** - базовые функции обработки

---

## АЛГОРИТМ РАБОТЫ (ПСЕВДОКОД)

```
1. ЗАГРУЗКА ДАННЫХ:
   sheets_data = load_sheets_maps()
   df_112 = load_112_data()

2. ПОСТРОЕНИЕ ИНДЕКСОВ:
   for каждая_запись in sheets_data:
       инцидент = запись.инцидент
       службы = извлечь_службы(запись.служба)
       
       if службы указаны:
           for служба in службы:
               incident_service_complaints[(инцидент, служба)].add(жалоба)
       else:
           incident_all_complaints[инцидент].add(жалоба)
       
       incident_status[инцидент] = статус
       incident_positive[инцидент] = положительно

3. ПРИМЕНЕНИЕ К 112:
   for каждая_запись in df_112:
       инцидент = запись.инцидент
       служба = запись.служба
       
       # Проверяем жалобы
       if (инцидент, служба) in incident_service_complaints:
           жалобы = incident_service_complaints[(инцидент, служба)]
       elif инцидент in incident_all_complaints:
           жалобы = incident_all_complaints[инцидент]
       
       # Статус применяем всегда
       статус = incident_status[инцидент]
       
       запись.жалоба = жалобы
       запись.статус = статус
       запись.есть_жалоба = (жалобы != пусто)

4. ФОРМИРОВАНИЕ ОТЧЕТОВ:
   for служба in [101, 102, 103, 104]:
       данные_службы = фильтр(df_112, служба)
       сводка = build_summary_counts(данные_службы)
       матрица = build_region_complaint_matrix(данные_службы)
       сохранить_excel(сводка, матрица, данные_службы)
```

---

## ВАЖНЫЕ ДЕТАЛИ

### Нормализация данных:
- Номера инцидентов: `str.strip()` для удаления пробелов
- Телефоны: удаление префикса +998 и форматирование
- Статусы: группировка схожих ("не удалось дозвониться", "занято" и т.п.)

### Обработка пустых значений:
- Пустые регионы → "Неизвестно"
- Пустые статусы → "Не удалось дозвониться"
- Пустые жалобы → `Есть_жалоба = False`

### Оптимизация памяти:
- Чтение больших CSV чанками по 200k строк
- Использование словарей вместо merge для сопоставления
- xlsxwriter с опцией `strings_to_urls=False`

---

## ВЫВОДЫ

1. **Полнота данных:** Все 234,178 записей из 112 учтены в отчетах
2. **Точность сопоставления:** 203,554 инцидента успешно сопоставлены с Sheets
3. **Структура отчетов:** 3 типа (детальные, сводки, общий) для разных задач
4. **Проверка:** Автоматические проверки показали 100% сходимость цифр

Система готова к использованию для анализа качества работы служб 112.

---

**Дата создания логики:** 02-03 февраля 2026  
**Автор системы:** GitHub Copilot + Azizvooy  
**Версия:** 1.0
