# Инструкция по использованию приложения для обработки данных

## Описание

Приложение для автоматической обработки данных из Google Sheets и системы 112. Программа запрашивает файлы, обрабатывает, сопоставляет данные по инцидентам и создаёт детальные отчёты.

## Запуск приложения

### Способ 1: Через BAT-файл (рекомендуется)
Просто запустите файл:
```
ОБРАБОТАТЬ_ДАННЫЕ.bat
```

### Способ 2: Через командную строку
```bash
.venv\Scripts\python.exe process_data_app.py
```

## Как пользоваться

### Шаг 1: Подготовка файлов

**Файл Google Sheets (CSV):**
- Должен содержать данные из Google Sheets
- Формат: CSV с кодировкой UTF-8
- Обязательная колонка: `Колонка_2` (номер инцидента)
- Колонка `Колонка_22` используется для определения жалоб

**Файлы 112 (Excel):**
- Один или несколько файлов формата .xlsx или .xls
- Должны быть файлами **журнала** (содержать колонку "Служба")
- Обязательные колонки:
  - `Инцидент` - номер инцидента
  - `Служба` - код службы (101, 102, 103, 104)
  - `Карта` - номер карточки
  - `Телефон` - номер телефона
  - `Статус` - статус обращения
  - `Регион`, `Район`, `Оператор` - для аналитики

### Шаг 2: Выбор файлов в приложении

1. Запустите приложение через `ОБРАБОТАТЬ_ДАННЫЕ.bat`
2. В окне приложения нажмите **"Выбрать файл CSV"** и укажите файл Google Sheets
3. Нажмите **"Выбрать файлы Excel"** и выберите один или несколько файлов 112
4. Проверьте список выбранных файлов в нижней части окна
5. Нажмите **"Начать обработку"**

### Шаг 3: Ожидание результатов

Приложение автоматически:
- ✅ Загрузит данные из всех файлов
- ✅ Удалит дубликаты
- ✅ Сопоставит данные по номерам инцидентов
- ✅ Применит бизнес-логику (жалобы/положительные)
- ✅ Создаст папку на рабочем столе с текущей датой
- ✅ Сгенерирует все отчёты

Процесс может занять несколько минут в зависимости от объёма данных.

## Результаты работы

### Папка на рабочем столе

Приложение создаст папку с названием вида:
```
Отчёты_112_2026-01-27_14-30
```

### Структура результатов

```
Отчёты_112_2026-01-27_14-30/
├── СОПОСТАВЛЕНИЕ_2026-01-27_14-30.csv          # Полные сопоставленные данные
├── СВОДКА_ПО_СЛУЖБАМ_2026-01-27_14-30.xlsx     # Сводная таблица по всем службам
├── СВОДНЫЙ_ОТЧЁТ_2026-01-27_14-30.txt          # Текстовый отчёт
└── службы_детально/                             # Детальные отчёты по службам
    ├── СЛУЖБА_101_Пожарная_2026-01-27_14-30.xlsx
    ├── СЛУЖБА_101_ЖАЛОБЫ_2026-01-27_14-30.csv
    ├── СЛУЖБА_102_Скорая помощь_2026-01-27_14-30.xlsx
    ├── СЛУЖБА_102_ЖАЛОБЫ_2026-01-27_14-30.csv
    ├── СЛУЖБА_103_Газовая_2026-01-27_14-30.xlsx
    ├── СЛУЖБА_103_ЖАЛОБЫ_2026-01-27_14-30.csv
    ├── СЛУЖБА_104_Аварийная_2026-01-27_14-30.xlsx
    └── СЛУЖБА_104_ЖАЛОБЫ_2026-01-27_14-30.csv
```

### Содержимое отчётов по службам

Каждый Excel-файл службы содержит 3 листа:

1. **СВОДКА** - общая статистика:
   - Уникальных инцидентов
   - Детальных записей (с учётом нескольких служб на инцидент)
   - Количество положительных
   - Количество отрицательных/жалоб
   - Проценты

2. **ПОЛОЖИТЕЛЬНЫЕ** - все положительные обращения с детальной информацией

3. **ЖАЛОБЫ** - все жалобы/отрицательные обращения с детальной информацией

## Бизнес-логика

### Правила категоризации:

**Положительно:**
- Если в Google Sheets нет жалобы (Колонка_22 пустая)
- Инцидент может содержать несколько служб - всем ставится "Положительно"

**Отрицательно:**
- Если в Google Sheets есть жалоба (Колонка_22 заполнена)
- Смотрим конкретную службу из данных 112
- Только этой службе ставится "Отрицательно"

### Переименование статусов:

Следующие статусы объединяются в "Не удалось дозвониться":
- Не отвечает
- Не берет трубку
- Сбрасывает
- Недоступен

### Удаление дубликатов:

Автоматически удаляются:
- Полные дубликаты строк
- Дубликаты по ключевым полям: Инцидент + Карта + Служба + Телефон

## Коды служб

- **101** - Пожарная служба
- **102** - Скорая помощь
- **103** - Газовая служба
- **104** - Аварийная служба

## Требования

- Python 3.7+
- Библиотеки: pandas, openpyxl, tkinter (входит в стандартную поставку Python)

## Устранение неполадок

### Приложение не запускается

Проверьте наличие виртуального окружения:
```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

### Ошибка при чтении файлов Excel

Убедитесь, что:
- Файлы не повреждены
- Файлы не открыты в другой программе
- Файлы содержат колонку "Служба" (файлы журнала, а не сводки)

### Нет сопоставленных данных

Проверьте:
- Формат номеров инцидентов одинаковый в обоих источниках
- Есть ли пересечения по датам между файлами

### Слишком большие числа в отчётах

Это исправлено в текущей версии. Приложение считает **уникальные инциденты** из Google Sheets, а не все строки после сопоставления.

## Технические детали

### Сопоставление данных

Данные сопоставляются по **номеру инцидента**:
- `Колонка_2` в Google Sheets → `Инцидент_Sheets`
- `Инцидент` в файлах 112 → `Инцидент_112`
- Сопоставление: `Инцидент_Sheets_norm` = `Инцидент_112_norm` (нормализованные значения)

### Нормализация

Для точного сопоставления номера инцидентов:
- Убираются пробелы в начале и конце
- Приводятся к верхнему регистру
- Сравнение производится на нормализованных значениях

### Обработка мультислужбных инцидентов

Один инцидент из Google Sheets может соответствовать нескольким записям в 112 (разные службы):
- Для статистики считаются **уникальные инциденты**
- Для детальных листов сохраняются **все записи**
- Это позволяет видеть полную картину, но статистика остаётся корректной

## Автор

Система автоматизированной обработки данных 112
Дата создания: 27.01.2026
