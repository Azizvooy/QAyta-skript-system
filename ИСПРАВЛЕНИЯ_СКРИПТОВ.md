# Исправления Скриптов Отчетов по Службам

**Дата:** 5 февраля 2026  
**Статус:** ✅ Исправлено

## Проблема

Скрипты создания отчетов по службам пытались загружать несуществующие файлы сопоставления вместо использования доступного файла `ALL_DATA_FIXED.csv`.

### Файлы с ошибками:
1. `create_detailed_service_reports.py`
2. `create_full_service_reports.py`  
3. `create_service_reports.py`

## Внесенные Исправления

### 1. create_detailed_service_reports.py
**До:**
```python
files = glob.glob('reports/СОПОСТАВЛЕНИЕ_ПО_ИНЦИДЕНТАМ_*.csv')
df = pd.read_csv(latest, low_memory=False)
```

**После:**
```python
data_file = Path('data') / 'ALL_DATA_FIXED.csv'
if not data_file.exists():
    data_file = Path('ALL_DATA_FIXED.csv')
df = pd.read_csv(data_file, encoding='utf-8-sig', low_memory=False)
```

**Дополнительно:**
- Добавлена автоопределение колонки службы (`Служба_112` или `Служба`)
- Добавлена поддержка разных названий статусов (русский, узбекский)
- Исправлены ссылки на колонки для универсальной работы с данными

---

### 2. create_full_service_reports.py
**До:**
```python
files = glob.glob('reports/СОПОСТАВЛЕНИЕ_ПО_ИНЦИДЕНТАМ_*.csv')
df_service_unique = df_service.drop_duplicates(subset=['Инцидент_Sheets'], keep='first')
```

**После:**
```python
data_file = Path('data') / 'ALL_DATA_FIXED.csv'
if not data_file.exists():
    data_file = Path('ALL_DATA_FIXED.csv')
card_col = 'Номер карты' if 'Номер карты' in df_service.columns else 'Карта_112'
df_service_unique = df_service.drop_duplicates(subset=[card_col], keep='first')
```

**Дополнительно:**
- Автоопределение колонок: `Служба`, `Статус`, `Регион`, `Район`, `Оператор`, `Документ`
- Добавлена обработка отсутствующих колонок (с предупреждениями)
- Улучшена логика определения положительных/отрицательных статусов

---

### 3. create_service_reports.py
**До:**
```python
match_files = list(data_dir.glob('СОПОСТАВЛЕНИЕ_ПОЛНОЕ_*.csv'))
services = df['Служба'].dropna().unique()
```

**После:**
```python
data_file = data_dir / 'ALL_DATA_FIXED.csv'
if not data_file.exists():
    data_file = BASE_DIR / 'ALL_DATA_FIXED.csv'
    
if 'Служба_112' in df.columns:
    service_col = 'Служба_112'
elif 'Служба' in df.columns:
    service_col = 'Служба'
services = df[service_col].dropna().unique()
```

**Дополнительно:**
- Все обращения к `df['Служба']` заменены на `df[service_col]`
- Добавлена проверка существования файла с понятным сообщением об ошибке

---

## Ключевые Улучшения

### ✅ Унификация источника данных
Все скрипты теперь используют один файл: `ALL_DATA_FIXED.csv`

### ✅ Гибкость работы с колонками
Автоматическое определение названий колонок:
- `Служба_112` или `Служба`
- `Статус` или `Статус_Sheets`
- `Номер карты` или `Карта_112`
- `Район` или `Район_112`
- И т.д.

### ✅ Многоязычная поддержка
Поддержка статусов на русском и узбекском языках:
- Положительный: `Положительн`, `qanoatlantir`, `қаноатлантир`
- Отрицательный: `Отрицательн`, `qanoatlantirilmadi`

### ✅ Отказоустойчивость
- Проверка существования файла с четким сообщением
- Обработка отсутствующих колонок
- Предупреждения вместо ошибок при отсутствии данных

---

## Расположение Файлов

### Данные:
- **Основной файл:** `data/ALL_DATA_FIXED.csv` или `ALL_DATA_FIXED.csv` (в корне)

### Отчеты создаются в:
- `reports/службы_детально/` - детальные отчеты по службам
- `reports/службы/` - базовые отчеты по службам
- `reports/` - сводные отчеты

---

## Как Использовать

### Запуск скриптов:

```bash
# Детальные отчеты с категоризацией
python create_detailed_service_reports.py

# Полный анализ с региональной статистикой
python create_full_service_reports.py

# Базовые отчеты по службам
python create_service_reports.py
```

### Требования:
- Наличие файла `ALL_DATA_FIXED.csv` в папке `data/` или в корне проекта
- Python 3.7+
- pandas, openpyxl

---

## Результат

Теперь все скрипты:
1. ✅ Корректно находят и загружают данные
2. ✅ Работают с различными структурами колонок
3. ✅ Создают детальные отчеты по службам 101, 102, 103, 104
4. ✅ Предоставляют статистику по положительным/отрицательным обращениям
5. ✅ Генерируют как Excel, так и текстовые отчеты

---

**Автор исправлений:** GitHub Copilot  
**Дата:** 5 февраля 2026
